version: '3.8'

services:
  app:
    build: .
    container_name: chainlit-rag-app-dev
    ports:
      - "8000:8000" # Chainlitå‰ç«¯
      - "5001:5000" # Flask API
    environment:
      # æ•°æ®åº“é…ç½®
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=chainlit_rag
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123

      # Redisé…ç½®
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis123

      # OpenAIé…ç½®
      - OPENAI_API_KEY=${OPENAI_API_KEY:-your-openai-api-key-here}
      - OPENAI_MODEL=gpt-3.5-turbo
      - OPENAI_EMBEDDING_MODEL=text-embedding-ada-002

      # åº”ç”¨é…ç½®
      - APP_MODE=docker
      - API_BASE_URL=http://localhost:5000
      - JWT_SECRET=docker-jwt-secret-change-in-production
      - VECTOR_DB_TYPE=faiss
      - FILE_UPLOAD_PATH=/app/uploads
      - VECTOR_INDEX_PATH=/app/data/vector_index

      # å¼€å‘æ¨¡å¼é…ç½®
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - FLASK_DEBUG=1
      - CHAINLIT_DEBUG=1

    volumes:
      # ğŸ”¥ å…³é”®ï¼šæŒ‚è½½æºä»£ç ç›®å½•ï¼Œå®ç°çƒ­é‡è½½
      - ./frontend:/app/frontend
      - ./backend:/app/backend
      - ./docker:/app/docker
      - ./configs:/app/configs
      - ./local_config.py:/app/local_config.py
      - ./docker/docker_config.py:/app/docker/docker_config.py

      # æ•°æ®ç›®å½•ï¼ˆæŒä¹…åŒ–ï¼‰
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./logs:/app/logs

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    # å¼€å‘æ¨¡å¼å¯åŠ¨å‘½ä»¤
    command: >
      bash -c "
        echo 'ğŸš€ å¼€å‘æ¨¡å¼å¯åŠ¨...'
        
        # ç­‰å¾…æ•°æ®åº“
        while ! pg_isready -h postgres -p 5432 -U postgres; do
          echo 'ç­‰å¾…æ•°æ®åº“...'
          sleep 2
        done
        
        # åˆå§‹åŒ–æ•°æ®åº“
        python docker/init_db.py
        
        # å¯åŠ¨APIæœåŠ¡å™¨ï¼ˆåå°ï¼Œå¸¦è‡ªåŠ¨é‡è½½ï¼‰
        python docker/integrated_server.py &
        
        # ç­‰å¾…APIå¯åŠ¨
        sleep 5
        
        # å¯åŠ¨Chainlitï¼ˆå¸¦è‡ªåŠ¨é‡è½½ï¼‰
        chainlit run frontend/app.py --host 0.0.0.0 --port 8000 --watch
      "

  postgres:
    image: postgres:15-alpine
    container_name: chainlit-rag-postgres-dev
    environment:
      POSTGRES_DB: chainlit_rag
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - rag-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: chainlit-rag-redis-dev
    command: redis-server --requirepass redis123
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    networks:
      - rag-network
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres_data_dev:
  redis_data_dev:


networks:
  rag-network:
    driver: bridge
