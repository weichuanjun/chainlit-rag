# Chainlit RAG 知识库系统 - 开发模式使用指南

## 🚀 快速开始

### 1. 启动开发环境

```bash
# 使用开发模式管理脚本
./docker-manage-dev.sh start

# 或者直接使用docker-compose
docker-compose -f docker-compose.dev.yml up -d
```

### 2. 验证环境

```bash
# 运行测试脚本验证所有组件
python test-dev-env.py

# 或者手动检查服务状态
./docker-manage-dev.sh status
```

### 3. 访问应用

- **Chainlit界面**: http://localhost:8000
- **API接口**: http://localhost:5001
- **健康检查**: http://localhost:5001/health

## 🔧 开发模式特性

### ✅ 热重载支持
- 源代码修改后自动重载
- 无需重启容器即可看到更改
- 支持前端和后端代码的热更新

### ✅ 数据持久化
- 数据库数据持久化存储
- Redis缓存数据持久化
- 上传文件持久化保存

### ✅ 开发工具
- 实时日志查看
- 快速重启服务
- 完整的测试套件

## 📁 目录结构

```
chainlit-rag/
├── frontend/           # 前端代码（热重载）
├── backend/           # 后端代码（热重载）
├── docker/            # Docker配置（热重载）
├── configs/           # 配置文件（热重载）
├── data/              # 数据目录（持久化）
├── uploads/           # 上传文件（持久化）
├── logs/              # 日志文件（持久化）
└── docker-compose.dev.yml  # 开发环境配置
```

## 🛠️ 常用命令

### 服务管理

```bash
# 启动开发环境
./docker-manage-dev.sh start

# 停止开发环境
./docker-manage-dev.sh stop

# 重启开发环境
./docker-manage-dev.sh restart

# 查看服务状态
./docker-manage-dev.sh status

# 查看日志
./docker-manage-dev.sh logs [service_name]

# 重新构建镜像
./docker-manage-dev.sh build

# 清理环境
./docker-manage-dev.sh clean
```

### 开发调试

```bash
# 查看实时日志
./docker-manage-dev.sh logs app

# 进入容器调试
docker-compose -f docker-compose.dev.yml exec app bash

# 查看数据库
docker-compose -f docker-compose.dev.yml exec postgres psql -U postgres -d chainlit_rag

# 查看Redis
docker-compose -f docker-compose.dev.yml exec redis redis-cli
```

## 🔐 用户认证

### 测试账号
- **邮箱**: test@example.com
- **密码**: testpass123
- **用户名**: testuser

### 注册新用户
1. 访问 http://localhost:8000
2. 点击"📝 注册"
3. 填写用户信息
4. 完成注册

### 登录
1. 访问 http://localhost:8000
2. 点击"🔐 登录"
3. 输入邮箱和密码（格式：邮箱,密码）
4. 完成登录

## 📄 文档管理

### 上传文档
1. **直接粘贴内容**: 在聊天框中粘贴文档内容
2. **创建示例文档**: 输入"创建示例文档"命令
3. **文件上传**: 通过聊天界面上传文件

### 支持的文档格式
- 文本文件 (.txt)
- Markdown文件 (.md)
- PDF文件 (.pdf)
- Word文档 (.docx, .doc)
- CSV文件 (.csv)
- JSON文件 (.json)

## 💬 聊天对话

### 基本对话
- 直接输入问题
- 系统会自动从知识库中检索相关信息
- 生成基于文档的回复

### 特殊命令
- `创建示例文档`: 创建一个测试文档
- 长文本内容: 自动识别为文档上传

## 🔍 故障排除

### 常见问题

#### 1. 服务启动失败
```bash
# 检查Docker状态
docker info

# 检查端口占用
lsof -i :8000
lsof -i :5001
lsof -i :5432
lsof -i :6379

# 清理并重新启动
./docker-manage-dev.sh clean
./docker-manage-dev.sh start
```

#### 2. 登录状态丢失
- 确保使用正确的API_BASE_URL配置
- 检查JWT_SECRET配置
- 查看浏览器控制台错误信息

#### 3. 文件上传失败
- 检查文件格式是否支持
- 确认文件大小不超过限制
- 查看服务日志获取详细错误信息

#### 4. 聊天回复异常
- 检查OpenAI API配置
- 确认向量数据库状态
- 查看API服务日志

### 日志查看

```bash
# 查看所有服务日志
./docker-manage-dev.sh logs

# 查看特定服务日志
./docker-manage-dev.sh logs app
./docker-manage-dev.sh logs postgres
./docker-manage-dev.sh logs redis

# 实时跟踪日志
docker-compose -f docker-compose.dev.yml logs -f app
```

### 性能优化

#### 1. 减少重启时间
```bash
# 只重启应用服务
docker-compose -f docker-compose.dev.yml restart app

# 只重新构建应用镜像
docker-compose -f docker-compose.dev.yml build app
```

#### 2. 清理资源
```bash
# 清理未使用的镜像
docker image prune -f

# 清理未使用的容器
docker container prune -f

# 清理未使用的网络
docker network prune -f
```

## 🔄 代码修改流程

### 1. 修改代码
- 直接编辑 `frontend/` 或 `backend/` 目录下的文件
- 代码会自动重载，无需重启容器

### 2. 验证更改
- 访问 http://localhost:8000 查看前端更改
- 使用测试脚本验证功能: `python test-dev-env.py`

### 3. 调试问题
- 查看实时日志: `./docker-manage-dev.sh logs app`
- 进入容器调试: `docker-compose -f docker-compose.dev.yml exec app bash`

### 4. 重启服务（如需要）
```bash
# 重启应用服务
docker-compose -f docker-compose.dev.yml restart app

# 或重启所有服务
./docker-manage-dev.sh restart
```

## 📊 监控和调试

### 健康检查
```bash
# API健康检查
curl http://localhost:5001/health

# 数据库连接检查
docker-compose -f docker-compose.dev.yml exec postgres pg_isready -U postgres

# Redis连接检查
docker-compose -f docker-compose.dev.yml exec redis redis-cli ping
```

### 性能监控
```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
docker system df

# 查看网络连接
docker network ls
```

## 🚀 部署准备

### 生产环境配置
1. 修改 `docker-compose.yml` 中的配置
2. 设置正确的环境变量
3. 配置生产数据库和Redis
4. 设置SSL证书

### 数据备份
```bash
# 备份数据库
docker-compose -f docker-compose.dev.yml exec postgres pg_dump -U postgres chainlit_rag > backup.sql

# 备份上传文件
tar -czf uploads_backup.tar.gz uploads/

# 备份向量索引
tar -czf vector_index_backup.tar.gz data/vector_index/
```

## 📞 技术支持

如果遇到问题，请：

1. 查看本文档的故障排除部分
2. 运行测试脚本: `python test-dev-env.py`
3. 查看服务日志: `./docker-manage-dev.sh logs`
4. 检查服务状态: `./docker-manage-dev.sh status`

---

**祝您开发愉快！** 🎉 